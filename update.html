<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f7f6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .search-area { margin-bottom: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #34495e; color: white; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-edit { background: #f39c12; color: white; margin-right: 5px; }
        .btn-del { background: #e74c3c; color: white; }
        
        /* Modal for Editing */
        #editModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; }
        .modal-content input { width: 90%; margin-bottom: 10px; padding: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Update / Delete Invoices</h2>
    <div class="search-area">
        <input type="text" id="searchBox" placeholder="Search Invoice ID or Client Name..." onkeyup="filterTable()">
    </div>

    <table id="updateTable">
        <thead>
            <tr>
                <th>Invoice ID</th>
                <th>Client Name</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="updateBody"></tbody>
    </table>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>Edit Invoice <span id="editIdDisplay"></span></h3>
        <label>Client Name:</label><br>
        <input type="text" id="editName"><br>
        <label>Client Phone:</label><br>
        <input type="text" id="editPhone"><br>
        <label>Total Amount:</label><br>
        <input type="number" id="editTotal"><br>
        <small>*Note: Item breakdown editing is locked for safety.</small><br><br>
        <button class="btn" style="background:#27ae60; color:white;" onclick="saveChanges()">Save Changes</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
    // Use your current Web App URL
    const API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec";
    const user = JSON.parse(localStorage.getItem("user"));
    let allData = [];
    let currentEditingId = "";

    window.onload = loadList;

    async function loadList() {
        if (!user || !user.sheetId) return;
        
        // Pass sheetId so GAS knows which file to open
        const response = await fetch(`${API_URL}?action=getInvoices&sheetId=${user.sheetId}`);
        allData = await response.json();
        const tbody = document.getElementById("updateBody");
        tbody.innerHTML = "";

        allData.forEach(inv => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${inv.invoiceId}</td>
                <td>${inv.clientName}</td>
                <td>${parseFloat(inv.total).toFixed(2)}</td>
                <td>
                    <button class="btn btn-edit" onclick="openEdit('${inv.invoiceId}')">Edit</button>
                    <button class="btn btn-del" onclick="deleteInv('${inv.invoiceId}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openEdit(id) {
        const inv = allData.find(i => i.invoiceId === id);
        currentEditingId = id;
        document.getElementById("editIdDisplay").innerText = id;
        document.getElementById("editName").value = inv.clientName;
        document.getElementById("editPhone").value = inv.clientPhone;
        document.getElementById("editTotal").value = inv.total;
        document.getElementById("editModal").style.display = "flex";
    }

    async function saveChanges() {
        const payload = {
            action: "updateInvoice",
            sheetId: user.sheetId,
            invoiceId: currentEditingId,
            clientName: document.getElementById("editName").value,
            clientPhone: document.getElementById("editPhone").value,
            total: document.getElementById("editTotal").value
        };

        // Use POST for updates
        await fetch(API_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(payload)
        });

        alert("Update request sent!");
        closeModal();
        // Give Google a second to process before refreshing
        setTimeout(loadList, 1500);
    }

    async function deleteInv(id) {
        if (confirm("Are you sure you want to permanently DELETE invoice " + id + "?")) {
            const payload = {
                action: "deleteInvoice",
                sheetId: user.sheetId,
                invoiceId: id
            };

            await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            });

            alert("Delete request sent!");
            setTimeout(loadList, 1500);
        }
    }

    function closeModal() { document.getElementById("editModal").style.display = "none"; }

    function filterTable() {
        const input = document.getElementById("searchBox").value.toUpperCase();
        document.querySelectorAll("#updateBody tr").forEach(row => {
            row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
        });
    }
</script>
</body>
</html>
