<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Update / Delete Invoices</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
        
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f7f6; transition: all 0.3s; }
        body.rtl-mode { direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        body.rtl-mode th, body.rtl-mode td { text-align: right; }

        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .search-area { margin-bottom: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #34495e; color: white; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .btn { border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.3s; }
        .btn-edit { background: #f39c12; color: white; margin-right: 5px; }
        .btn-del { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.8; }
        
        /* Modal for Editing */
        #editModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; color: #2c3e50; }
        .modal-content label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-content input { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 data-key="title">Update / Delete Invoices</h2>
    <div class="search-area">
        <input type="text" id="searchBox" placeholder="Search..." data-placeholder="searchPlace" onkeyup="filterTable()">
    </div>

    <table id="updateTable">
        <thead>
            <tr>
                <th data-key="thInvId">Invoice ID</th>
                <th data-key="thClient">Client Name</th>
                <th data-key="thTotal">Total</th>
                <th data-key="thActions">Actions</th>
            </tr>
        </thead>
        <tbody id="updateBody"></tbody>
    </table>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3><span data-key="modalTitle">Edit Invoice</span> #<span id="editIdDisplay"></span></h3>
        
        <label data-key="thClient">Client Name:</label>
        <input type="text" id="editName">
        
        <label data-key="lblPhone">Client Phone:</label>
        <input type="text" id="editPhone">
        
        <label data-key="thTotal">Total Amount:</label>
        <input type="number" id="editTotal">
        
        <p><small data-key="editNote">*Note: Item breakdown editing is locked for safety.</small></p>
        
        <div class="modal-buttons">
            <button class="btn" style="background:#27ae60; color:white;" onclick="saveChanges()" data-key="btnSave">Save Changes</button>
            <button class="btn" onclick="closeModal()" data-key="btnCancel">Cancel</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec";
    const user = JSON.parse(localStorage.getItem("user"));
    let allData = [];
    let currentEditingId = "";

    const i18n = {
        en: {
            title: "Update / Delete Invoices",
            searchPlace: "ðŸ” Search Invoice ID or Client Name...",
            thInvId: "Invoice ID", thClient: "Client Name", thTotal: "Total", thActions: "Actions",
            modalTitle: "Edit Invoice", lblPhone: "Client Phone", btnSave: "Save Changes",
            btnCancel: "Cancel", editNote: "*Note: Item breakdown editing is locked for safety.",
            msgUpdate: "Update request sent!", msgDelete: "Are you sure you want to delete invoice ",
            btnEdit: "Edit", btnDel: "Delete"
        },
        ur: {
            title: "Ø§Ù†ÙˆØ§Ø¦Ø³ Ø§Ù¾ ÚˆÛŒÙ¹ ÛŒØ§ ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø±ÛŒÚº",
            searchPlace: "ðŸ” ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº...",
            thInvId: "Ø§Ù†ÙˆØ§Ø¦Ø³ Ø¢Ø¦ÛŒ ÚˆÛŒ", thClient: "Ú©Ù„Ø§Ø¦Ù†Ù¹ Ú©Ø§ Ù†Ø§Ù…", thTotal: "Ú©Ù„ Ø±Ù‚Ù…", thActions: "Ø§ÛŒÚ©Ø´Ù†Ø²",
            modalTitle: "Ø§Ù†ÙˆØ§Ø¦Ø³ Ø§ÛŒÚˆÙ¹ Ú©Ø±ÛŒÚº", lblPhone: "ÙÙˆÙ† Ù†Ù…Ø¨Ø±", btnSave: "Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº",
            btnCancel: "Ú©ÛŒÙ†Ø³Ù„", editNote: "*Ù†ÙˆÙ¹: Ø§Ø´ÛŒØ§Ø¡ Ú©ÛŒ ØªÙØµÛŒÙ„ Ù…ÛŒÚº ØªØ¨Ø¯ÛŒÙ„ÛŒ ÛŒÛØ§Úº Ù…Ù…Ú©Ù† Ù†ÛÛŒÚº ÛÛ’Û”",
            msgUpdate: "Ø§Ù¾ ÚˆÛŒÙ¹ Ú©ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒ Ú¯Ø¦ÛŒ ÛÛ’!", msgDelete: "Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ù†ÙˆØ§Ø¦Ø³ ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ ",
            btnEdit: "ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº", btnDel: "Ø®ØªÙ… Ú©Ø±ÛŒÚº"
        }
    };

    window.onload = () => { applyLanguage(); loadList(); };

    function applyLanguage() {
        const lang = localStorage.getItem("dashboardLang") || "en";
        const t = i18n[lang];
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (t[key]) el.innerText = t[key];
        });
        document.getElementById("searchBox").placeholder = t.searchPlace;
        document.body.classList.toggle('rtl-mode', lang === 'ur');
    }

    async function loadList() {
        if (!user || !user.sheetId) return;
        
        try {
            const response = await fetch(`${API_URL}?action=getInvoices&sheetId=${user.sheetId}`);
            const rawData = await response.json();
            
            // CORRECT MAPPING: uppercase from GS to lowercase for HTML
            allData = rawData.map(row => ({
                invoiceId: row.Invoice_ID,
                clientName: row.Client_Name,
                clientPhone: row.Client_Phone,
                total: row.Total_Amount
            }));

            const tbody = document.getElementById("updateBody");
            tbody.innerHTML = "";
            const lang = localStorage.getItem("dashboardLang") || "en";

            allData.forEach(inv => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${inv.invoiceId}</td>
                    <td>${inv.clientName}</td>
                    <td>${parseFloat(inv.total).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openEdit('${inv.invoiceId}')">${i18n[lang].btnEdit}</button>
                        <button class="btn btn-del" onclick="deleteInv('${inv.invoiceId}')">${i18n[lang].btnDel}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) { console.error("Load failed", e); }
    }

    function openEdit(id) {
        const inv = allData.find(i => i.invoiceId === id);
        if(!inv) return;
        
        currentEditingId = id;
        document.getElementById("editIdDisplay").innerText = id;
        document.getElementById("editName").value = inv.clientName;
        document.getElementById("editPhone").value = inv.clientPhone;
        document.getElementById("editTotal").value = inv.total;
        document.getElementById("editModal").style.display = "flex";
    }

    async function saveChanges() {
        const lang = localStorage.getItem("dashboardLang") || "en";
        const payload = {
            action: "updateInvoice",
            sheetId: user.sheetId,
            invoiceId: currentEditingId,
            clientName: document.getElementById("editName").value,
            clientPhone: document.getElementById("editPhone").value,
            total: document.getElementById("editTotal").value
        };

        await fetch(API_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(payload)
        });

        alert(i18n[lang].msgUpdate);
        closeModal();
        setTimeout(loadList, 1500);
    }

    async function deleteInv(id) {
        const lang = localStorage.getItem("dashboardLang") || "en";
        if (confirm(i18n[lang].msgDelete + id + "?")) {
            const payload = {
                action: "deleteInvoice",
                sheetId: user.sheetId,
                invoiceId: id
            };

            await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            });

            setTimeout(loadList, 1500);
        }
    }

    function closeModal() { document.getElementById("editModal").style.display = "none"; }

    function filterTable() {
        const input = document.getElementById("searchBox").value.toUpperCase();
        document.querySelectorAll("#updateBody tr").forEach(row => {
            row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
        });
    }
</script>
</body>
</html>
