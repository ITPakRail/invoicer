<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: white; transition: all 0.3s; }
        body.rtl-mode { font-family: 'Noto Nastaliq Urdu', serif; direction: rtl; }
        body.rtl-mode input { font-family: 'Noto Nastaliq Urdu', serif; text-align: right; }

        .brand-section { margin-bottom: 20px; text-align: left; }
        body.rtl-mode .brand-section { text-align: right; }
        #business-logo { max-width: 150px; max-height: 80px; display: none; margin-bottom: 5px; object-fit: contain; }
        #business-name { font-size: 1.5em; font-weight: bold; color: #2c3e50; margin: 0; }

        .header-flex { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; }
        input { width: 95%; border: 1px solid #eee; padding: 5px; outline: none; }
        input:focus { border-color: #3498db; }
        
        .total-container { margin-top: 20px; text-align: right; font-weight: bold; }
        body.rtl-mode .total-container { text-align: left; }
        .total-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; font-size: 1.1em; align-items: center; }
        body.rtl-mode .total-row { justify-content: flex-start; flex-direction: row-reverse; }
        
        .grand-total-row { font-size: 1.6em; color: #2e7d32; border-top: 2px solid #2e7d32; display: inline-block; padding-top: 5px; min-width: 250px; }
        .payment-row { color: #2c3e50; margin-top: 10px; }
        .balance-row { color: #e74c3c; font-size: 1.3em; }
        .payment-input { width: 100px; font-size: 1em; font-weight: bold; border-bottom: 2px solid #3498db; text-align: right; }
        
        .btn-gen { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .btn-gen:hover { background: #219150; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; border: none; background: none; }
        .print-only { display: none; }

        /* Logic to hide rows if zero during print */
        .hide-on-print { display: none !important; }

        @media print {
            .btn-gen, .delete-btn, #item-body tr td:last-child, th:last-child, .no-print { display: none !important; }
            .print-only { display: inline !important; }
            input { border: none; background: transparent; }
            .header-flex { background: none; border-bottom: 1px solid #ddd; }
            .payment-input { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="brand-section">
        <img id="business-logo" src="" alt="Logo">
        <div id="business-name"></div>
    </div>

    <div class="header-flex">
        <div><strong data-key="invIdLabel">Invoice ID:</strong> <span id="display-inv-id">--</span></div>
        <div><strong data-key="dateLabel">Date:</strong> <span id="display-date">--</span></div>
    </div>

    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <div style="flex: 2;">
            <label><strong data-key="clientLabel">Client Name:</strong></label>
            <input type="text" id="client-name" class="urdu-input" list="client-list" placeholder="Select or Type Client Name" data-placeholder="clientPlace" style="width: 100%; padding: 8px;" onchange="autoFillClient(this.value)">
            <datalist id="client-list"></datalist>
        </div>
        <div style="flex: 1;">
            <label><strong data-key="phoneLabel">Phone (Optional):</strong></label>
            <input type="text" id="client-phone" placeholder="e.g. 923001234567" data-placeholder="phonePlace" style="width: 100%; padding: 8px;">
        </div>
    </div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th data-key="thDesc">Description</th>
                <th width="80" data-key="thQty">Qty</th>
                <th width="120" data-key="thPrice">Price</th>
                <th width="120" data-key="thAmt">Amount</th>
                <th width="40" class="no-print"></th>
            </tr>
        </thead>
        <tbody id="item-body"></tbody>
    </table>
    
    <datalist id="items-list"></datalist>

    <div class="total-container">
        <div class="total-row">
            <span data-key="lblSub">Subtotal:</span>
            <span><span class="curr-symbol"></span> <span id="sub-total">0.00</span></span>
        </div>

        <div class="total-row" id="discount-row">
            <span><span data-key="lblDiscount">Discount</span> (<input type="number" id="discount-percent" class="no-print" style="width:45px; border-bottom:1px solid #3498db" value="0" oninput="calculate()">%):</span>
            <span><span class="curr-symbol"></span> <span id="discount-amount">0.00</span></span>
        </div>

        <div class="total-row" id="tax-row">
            <span><span data-key="lblTax">Tax</span> (<span id="tax-rate-display">0</span>%):</span>
            <span><span class="curr-symbol"></span> <span id="tax-amount">0.00</span></span>
        </div>

        <div class="total-row grand-total-row">
            <span data-key="lblGrand">Grand Total:</span>
            <span><span class="curr-symbol"></span> <span id="grand-total">0.00</span></span>
        </div>
        
        <div class="total-row payment-row">
            <span data-key="lblPaid">Amount Received:</span>
            <span>
                <span class="curr-symbol"></span> 
                <input type="number" id="paid-amount" class="payment-input no-print" value="0" oninput="calculate()">
                <span id="print-paid-amount" class="print-only">0.00</span>
            </span>
        </div>
        <div class="total-row balance-row">
            <span data-key="lblBalance">Balance (Udhaar):</span>
            <span><span class="curr-symbol"></span> <span id="balance-amount">0.00</span></span>
        </div>
    </div>

    <button class="btn-gen" onclick="submitInvoice()" data-key="btnSave">Generate & Save Invoice</button>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec";
        const user = JSON.parse(localStorage.getItem("user"));
        let taxPercent = 0;
        let clientsArray = [];
        let savedItemsArray = [];

        const i18n = {
            en: {
                invIdLabel: "Invoice ID:", dateLabel: "Date:", clientLabel: "Client Name:", 
                phoneLabel: "Phone (Optional):", thDesc: "Description", thQty: "Qty", 
                thPrice: "Price", thAmt: "Amount", lblSub: "Subtotal:", lblTax: "Tax", 
                lblDiscount: "Discount", lblGrand: "Grand Total:", lblPaid: "Amount Received:", 
                lblBalance: "Balance:", btnSave: "Generate & Save Invoice",
                clientPlace: "Select or Type Client Name", phonePlace: "e.g. 923001234567"
            },
            ur: {
                invIdLabel: "انوائس نمبر:", dateLabel: "تاریخ:", clientLabel: "کلائنٹ کا نام:", 
                phoneLabel: "فون (اختیاری):", thDesc: "تفصیل", thQty: "تعداد", 
                thPrice: "قیمت", thAmt: "رقم", lblSub: "رقم:", lblTax: "ٹیکس", 
                lblDiscount: "رعایت", lblGrand: "کل رقم:", lblPaid: "وصول شدہ رقم:", 
                lblBalance: "بقایا (ادھار):", btnSave: "انوائس محفوظ کریں",
                clientPlace: "کلائنٹ کا نام منتخب کریں", phonePlace: "مثلاً 923001234567"
            }
        };

        const urduMap = {
            'a': 'ا', 'b': 'ب', 'c': 'چ', 'd': 'د', 'e': 'ع', 'f': 'ف', 'g': 'گ', 'h': 'ہ', 'i': 'ی', 'j': 'ج',
            'k': 'ک', 'l': 'ل', 'm': 'م', 'n': 'ن', 'o': 'ہ', 'p': 'پ', 'q': 'ق', 'r': 'ر', 's': 'س', 't': 'ت',
            'u': 'و', 'v': 'ط', 'w': 'و', 'x': 'ش', 'y': 'ے', 'z': 'ز', 'A': 'آ', 'S': 'ص', 'D': 'ڈ', 'T': 'ٹ'
        };

        function enableUrduTyping(e) {
            const lang = localStorage.getItem("dashboardLang") || "en";
            if (lang !== 'ur') return;
            if (urduMap[e.key]) {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                const text = e.target.value;
                e.target.value = text.substring(0, start) + urduMap[e.key] + text.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 1;
            }
        }

        function applyFormLanguage() {
            const lang = localStorage.getItem("dashboardLang") || "en";
            const t = i18n[lang];
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (t[key]) el.innerText = t[key];
            });
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            document.body.classList.toggle('rtl-mode', lang === 'ur');
        }

        document.addEventListener('keypress', (e) => {
            if (e.target.classList.contains('urdu-input') || e.target.classList.contains('row-desc')) {
                enableUrduTyping(e);
            }
        });

     window.onload = async () => {
            applyFormLanguage();
            document.getElementById("display-date").innerText = new Date().toLocaleDateString();
            
            if (!user) return alert("Session expired.");

            const bName = document.getElementById("business-name");
            const bLogo = document.getElementById("business-logo");
            bName.innerText = user.business || "My Business";
            if (user.logo && user.logo.trim() !== "") {
                bLogo.src = user.logo;
                bLogo.style.display = "block";
            }

            // Using original names for loading memory
            clientsArray = JSON.parse(localStorage.getItem("clients") || "[]");
            savedItemsArray = JSON.parse(localStorage.getItem("items") || "[]");

            const dataList = document.getElementById("client-list");
            dataList.innerHTML = ""; 
            clientsArray.forEach(c => {
                const option = document.createElement("option");
                option.value = c.name || c.Client_Name || ""; 
                dataList.appendChild(option);
            });

            const itemDL = document.getElementById("items-list");
            itemDL.innerHTML = ""; 
            savedItemsArray.forEach(item => {
                const option = document.createElement("option");
                option.value = item.name || item.itemName || "";
                itemDL.appendChild(option);
            });

            addNewRow(); 

            try {
                const idRes = await fetch(`${API_URL}?action=getNextId&sheetId=${user.sheetId}`);
                const idData = await idRes.json();
                document.getElementById("display-inv-id").innerText = idData.nextId;

                const setRes = await fetch(`${API_URL}?action=getSettings&sheetId=${user.sheetId}`);
                const setData = await setRes.json();
                if(setData.status === "Success") {
                    taxPercent = parseFloat(setData.taxRate) || 0;
                    document.getElementById("tax-rate-display").innerText = taxPercent;
                }

                const currRes = await fetch(`${API_URL}?action=getCurrency&sheetId=${user.sheetId}`);
                const currData = await currRes.json();
                if(currData.status === "Success") {
                    document.querySelectorAll(".curr-symbol").forEach(s => s.innerText = currData.currSymbol || "");
                }
            } catch (e) { console.error("Error loading settings:", e); }
        };

        function autoFillClient(val) {
            const found = clientsArray.find(c => (c.name === val || c.Client_Name === val));
            if (found) {
                document.getElementById("client-phone").value = found.phone || "";
            }
        }

        function autoFillPrice(inputEl) {
            const found = savedItemsArray.find(i => i.name === inputEl.value);
            if (found) {
                const row = inputEl.parentElement.parentElement;
                row.querySelector(".row-price").value = found.price;
                calculate();
            }
        }
        
        function addNewRow() {
            const tbody = document.getElementById("item-body");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" class="row-desc" list="items-list" placeholder="..." onchange="autoFillPrice(this)"></td>
                <td><input type="number" class="row-qty" value="1" oninput="calculate()"></td>
                <td><input type="number" class="row-price" value="0" oninput="calculate()" onblur="checkAutoRow(this)"></td>
                <td class="row-amt" style="text-align:right">0.00</td>
                <td style="text-align:center" class="no-print"><button class="delete-btn" onclick="removeRow(this)">✖</button></td>
            `;
            tbody.appendChild(tr);
        }

        function removeRow(btn) {
            if (document.querySelectorAll("#item-body tr").length > 1) {
                btn.parentElement.parentElement.remove();
                calculate();
            }
        }

        function checkAutoRow(input) {
            const rows = document.querySelectorAll("#item-body tr");
            if (input.parentElement.parentElement === rows[rows.length - 1] && input.value > 0) addNewRow();
        }

        function calculate() {
            let subtotal = 0;
            document.querySelectorAll("#item-body tr").forEach(row => {
                const amt = (parseFloat(row.querySelector(".row-qty").value) || 0) * (parseFloat(row.querySelector(".row-price").value) || 0);
                row.querySelector(".row-amt").innerText = amt.toFixed(2);
                subtotal += amt;
            });

            // Discount logic
            const discPercent = parseFloat(document.getElementById("discount-percent").value) || 0;
            const discAmount = (subtotal * discPercent) / 100;
            
            // Tax logic
            const taxAmount = (subtotal * taxPercent) / 100;
            
            const grandTotal = subtotal + taxAmount - discAmount;
            const paid = parseFloat(document.getElementById("paid-amount").value) || 0;
            
            document.getElementById("sub-total").innerText = subtotal.toFixed(2);
            document.getElementById("discount-amount").innerText = discAmount.toFixed(2);
            document.getElementById("tax-amount").innerText = taxAmount.toFixed(2);
            document.getElementById("grand-total").innerText = grandTotal.toFixed(2);
            document.getElementById("balance-amount").innerText = (grandTotal - paid).toFixed(2);
            document.getElementById("print-paid-amount").innerText = paid.toFixed(2);

            // Hide rows for print if values are zero
            document.getElementById("discount-row").classList.toggle("hide-on-print", discAmount <= 0);
            document.getElementById("tax-row").classList.toggle("hide-on-print", taxAmount <= 0);
        }

        async function submitInvoice() {
            const client = document.getElementById("client-name").value;
            if (!client) return alert("Please enter Client Name");
            
            const grandTotal = parseFloat(document.getElementById("grand-total").innerText);
            const paidAmount = parseFloat(document.getElementById("paid-amount").value) || 0;
            const balanceAmount = grandTotal - paidAmount;
            let status = (paidAmount === 0) ? "Unpaid" : (balanceAmount > 0 ? "Partial" : "Paid");

            const btn = document.querySelector(".btn-gen");
            btn.disabled = true; btn.innerText = "...";

            const items = [];
            document.querySelectorAll("#item-body tr").forEach(row => {
                const desc = row.querySelector(".row-desc").value;
                if (desc) {
                    items.push({
                        description: desc,
                        qty: row.querySelector(".row-qty").value,
                        price: row.querySelector(".row-price").value,
                        amount: row.querySelector(".row-amt").innerText
                    });
                }
            });

            const payload = {
                action: "saveInvoice",
                sheetId: user.sheetId,
                invoiceId: document.getElementById("display-inv-id").innerText,
                userId: user.id,
                clientName: client,
                clientPhone: document.getElementById("client-phone").value,
                date: document.getElementById("display-date").innerText,
                subtotal: document.getElementById("sub-total").innerText,
                taxAmount: document.getElementById("tax-amount").innerText,
                discountAmount: document.getElementById("discount-amount").innerText,
                total: grandTotal.toFixed(2),
                items: items,
                paidAmount: paidAmount.toFixed(2),
                balanceAmount: balanceAmount.toFixed(2),
                status: status
            };

            try {
                await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                alert("✅ Invoice Saved!");
                window.print();
                window.location.reload(); 
            } catch (err) {
                alert("Error saving invoice.");
                btn.disabled = false; btn.innerText = "Generate & Save Invoice";
            }
        }
    </script>
</body>
</html>
