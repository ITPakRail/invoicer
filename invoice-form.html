<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: white; }
        .header-flex { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; }
        input { width: 95%; border: 1px solid #eee; padding: 5px; outline: none; }
        input:focus { border-color: #3498db; }
        
        .total-container { margin-top: 20px; text-align: right; font-weight: bold; }
        .total-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; font-size: 1.1em; }
        .grand-total-row { font-size: 1.6em; color: #2e7d32; border-top: 2px solid #2e7d32; display: inline-block; padding-top: 5px; min-width: 250px; }
        
        .btn-gen { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .btn-gen:hover { background: #219150; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; border: none; background: none; }

        @media print {
            .btn-gen, .delete-btn, #item-body tr td:last-child, th:last-child { display: none; }
            input { border: none; }
            .header-flex { background: none; border-bottom: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="header-flex">
        <div><strong>Invoice ID:</strong> <span id="display-inv-id">--</span></div>
        <div><strong>Date:</strong> <span id="display-date">--</span></div>
    </div>

   <div style="margin-bottom: 20px; display: flex; gap: 10px;">
    <div style="flex: 2;">
        <label><strong>Client Name:</strong></label>
        <input type="text" id="client-name" list="client-list" placeholder="Select or Type Client Name" style="width: 100%; padding: 8px;" onchange="autoFillClient(this.value)">
        <datalist id="client-list"></datalist>
    </div>
    <div style="flex: 1;">
        <label><strong>Phone (Optional):</strong></label>
        <input type="text" id="client-phone" placeholder="e.g. 923001234567" style="width: 100%; padding: 8px;">
    </div>
</div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th>Description</th>
                <th width="80">Qty</th>
                <th width="120">Price</th>
                <th width="120">Amount</th>
                <th width="40" class="no-print"></th>
            </tr>
        </thead>
        <tbody id="item-body">
        </tbody>
    </table>

    <div class="total-container">
        <div class="total-row">
            <span>Subtotal:</span>
            <span><span class="curr-symbol"></span> <span id="sub-total">0.00</span></span>
        </div>
        <div class="total-row">
            <span>Tax (<span id="tax-rate-display">0</span>%):</span>
            <span><span class="curr-symbol"></span> <span id="tax-amount">0.00</span></span>
        </div>
        <div class="total-row grand-total-row">
            <span>Grand Total:</span>
            <span><span class="curr-symbol"></span> <span id="grand-total">0.00</span></span>
        </div>
    </div>

    <button class="btn-gen" onclick="submitInvoice()">Generate & Save Invoice</button>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwKgib802NVM4Mn31in9KhfoMHPA9b2tubCMLq7lDrCmthRNyryOiPaAT5FBrnL_qto/exec";
        const user = JSON.parse(localStorage.getItem("user"));
        let taxPercent = 0;
        let clientsArray = []; // To store fetched client data for autofill

        window.onload = async () => {
            document.getElementById("display-date").innerText = new Date().toLocaleDateString();
            addNewRow(); 
            
            if (!user || !user.id) return alert("Session expired.");

            try {
                // Fetch ID
                const idRes = await fetch(`${API_URL}?action=getNextId&userId=${encodeURIComponent(user.id)}`);
                const idData = await idRes.json();
                document.getElementById("display-inv-id").innerText = idData.nextId;

                // Fetch Settings
                const setRes = await fetch(`${API_URL}?action=getSettings&id=${user.id}`);
                const setData = await setRes.json();
                if(setData.status === "Success") {
                    taxPercent = parseFloat(setData.taxRate) || 0;
                    document.getElementById("tax-rate-display").innerText = taxPercent;
                    document.querySelectorAll(".curr-symbol").forEach(s => s.innerText = setData.currSymbol || "");
                }

                // NEW: Fetch Clients for the dropdown
                const clientRes = await fetch(`${API_URL}?action=getClients&userId=${user.id}`);
                clientsArray = await clientRes.json();
                const dataList = document.getElementById("client-list");
                clientsArray.forEach(c => {
                    const option = document.createElement("option");
                    option.value = c.name;
                    dataList.appendChild(option);
                });

            } catch (e) { document.getElementById("display-inv-id").innerText = "INV-1001"; }
        };

        // NEW: Auto-fill phone when client is selected from list
        function autoFillClient(val) {
            const found = clientsArray.find(c => c.name === val);
            if (found) {
                document.getElementById("client-phone").value = found.phone || "";
            }
        }

        function addNewRow() {
            const tbody = document.getElementById("item-body");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" class="row-desc" placeholder="Item name..."></td>
                <td><input type="number" class="row-qty" value="1" oninput="calculate()"></td>
                <td><input type="number" class="row-price" value="0" oninput="calculate()" onblur="checkAutoRow(this)"></td>
                <td class="row-amt" style="text-align:right">0.00</td>
                <td style="text-align:center" class="no-print"><button class="delete-btn" onclick="removeRow(this)">✖</button></td>
            `;
            tbody.appendChild(tr);
        }

        function checkAutoRow(input) {
            const rows = document.querySelectorAll("#item-body tr");
            if (input.parentElement.parentElement === rows[rows.length - 1] && input.value > 0) addNewRow();
        }

        function removeRow(btn) {
            if (document.querySelectorAll("#item-body tr").length > 1) {
                btn.parentElement.parentElement.remove();
                calculate();
            }
        }

        function calculate() {
            let subtotal = 0;
            document.querySelectorAll("#item-body tr").forEach(row => {
                const amt = (row.querySelector(".row-qty").value || 0) * (row.querySelector(".row-price").value || 0);
                row.querySelector(".row-amt").innerText = amt.toFixed(2);
                subtotal += amt;
            });
            const taxTotal = (subtotal * taxPercent) / 100;
            document.getElementById("sub-total").innerText = subtotal.toFixed(2);
            document.getElementById("tax-amount").innerText = taxTotal.toFixed(2);
            document.getElementById("grand-total").innerText = (subtotal + taxTotal).toFixed(2);
        }

        async function submitInvoice() {
            const client = document.getElementById("client-name").value;
            if (!client) return alert("Please enter Client Name");

            const btn = document.querySelector(".btn-gen");
            btn.disabled = true; btn.innerText = "Saving...";

            const items = [];
            document.querySelectorAll("#item-body tr").forEach(row => {
                const desc = row.querySelector(".row-desc").value;
                if (desc) {
                    items.push({
                        description: desc,
                        qty: row.querySelector(".row-qty").value,
                        price: row.querySelector(".row-price").value,
                        amount: row.querySelector(".row-amt").innerText
                    });
                }
            });

            const payload = {
                action: "saveInvoice",
                invoiceId: document.getElementById("display-inv-id").innerText,
                userId: user.id,
                clientName: client,
                clientPhone: document.getElementById("client-phone").value,
                date: document.getElementById("display-date").innerText,
                subtotal: document.getElementById("sub-total").innerText,
                taxAmount: document.getElementById("tax-amount").innerText,
                total: document.getElementById("grand-total").innerText,
                items: items
            };

            try {
                await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                alert("✅ Invoice Saved!");
                window.print();
                window.location.reload(); 
            } catch (err) {
                alert("Error saving invoice.");
                btn.disabled = false; btn.innerText = "Generate & Save Invoice";
            }
        }
    </script>
</body>
</html>
