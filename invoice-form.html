<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: white; transition: all 0.3s; }
        .header-flex { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; }
        input { width: 95%; border: 1px solid #eee; padding: 5px; outline: none; }
        input:focus { border-color: #3498db; }
        
        .total-container { margin-top: 20px; text-align: right; font-weight: bold; }
        /* Adjusted for RTL compatibility */
        body.rtl-mode .total-container { text-align: left; }
        
        .total-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; font-size: 1.1em; }
        body.rtl-mode .total-row { justify-content: flex-start; flex-direction: row-reverse; }

        .grand-total-row { font-size: 1.6em; color: #2e7d32; border-top: 2px solid #2e7d32; display: inline-block; padding-top: 5px; min-width: 250px; }
        
        .btn-gen { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .btn-gen:hover { background: #219150; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; border: none; background: none; }

        @media print {
            .btn-gen, .delete-btn, #item-body tr td:last-child, th:last-child { display: none; }
            input { border: none; }
            .header-flex { background: none; border-bottom: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="header-flex">
        <div><strong data-key="invIdLabel">Invoice ID:</strong> <span id="display-inv-id">--</span></div>
        <div><strong data-key="dateLabel">Date:</strong> <span id="display-date">--</span></div>
    </div>

   <div style="margin-bottom: 20px; display: flex; gap: 10px;">
    <div style="flex: 2;">
        <label><strong data-key="clientLabel">Client Name:</strong></label>
        <input type="text" id="client-name" list="client-list" placeholder="Select or Type Client Name" data-placeholder="clientPlace" style="width: 100%; padding: 8px;" onchange="autoFillClient(this.value)">
        <datalist id="client-list"></datalist>
    </div>
    <div style="flex: 1;">
        <label><strong data-key="phoneLabel">Phone (Optional):</strong></label>
        <input type="text" id="client-phone" placeholder="e.g. 923001234567" data-placeholder="phonePlace" style="width: 100%; padding: 8px;">
    </div>
</div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th data-key="thDesc">Description</th>
                <th width="80" data-key="thQty">Qty</th>
                <th width="120" data-key="thPrice">Price</th>
                <th width="120" data-key="thAmt">Amount</th>
                <th width="40" class="no-print"></th>
            </tr>
        </thead>
        <tbody id="item-body">
        </tbody>
    </table>

    <div class="total-container">
        <div class="total-row">
            <span data-key="lblSub">Subtotal:</span>
            <span><span class="curr-symbol"></span> <span id="sub-total">0.00</span></span>
        </div>
        <div class="total-row">
            <span><span data-key="lblTax">Tax</span> (<span id="tax-rate-display">0</span>%):</span>
            <span><span class="curr-symbol"></span> <span id="tax-amount">0.00</span></span>
        </div>
        <div class="total-row grand-total-row">
            <span data-key="lblGrand">Grand Total:</span>
            <span><span class="curr-symbol"></span> <span id="grand-total">0.00</span></span>
        </div>
    </div>

    <button class="btn-gen" onclick="submitInvoice()" data-key="btnSave">Generate & Save Invoice</button>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec";
        const user = JSON.parse(localStorage.getItem("user"));
        let taxPercent = 0;
        let clientsArray = [];

        // LANGUAGE DICTIONARY
        const i18n = {
            en: {
                invIdLabel: "Invoice ID:", dateLabel: "Date:", clientLabel: "Client Name:", 
                phoneLabel: "Phone (Optional):", thDesc: "Description", thQty: "Qty", 
                thPrice: "Price", thAmt: "Amount", lblSub: "Subtotal:", lblTax: "Tax", 
                lblGrand: "Grand Total:", btnSave: "Generate & Save Invoice",
                clientPlace: "Select or Type Client Name", phonePlace: "e.g. 923001234567"
            },
            ur: {
                invIdLabel: "انوائس نمبر:", dateLabel: "تاریخ:", clientLabel: "کلائنٹ کا نام:", 
                phoneLabel: "فون (اختیاری):", thDesc: "تفصیل", thQty: "تعداد", 
                thPrice: "قیمت", thAmt: "رقم", lblSub: "رقم:", lblTax: "ٹیکس", 
                lblGrand: "کل رقم:", btnSave: "انوائس محفوظ کریں",
                clientPlace: "کلائنٹ کا نام منتخب کریں", phonePlace: "مثلاً 923001234567"
            }
        };

        function applyFormLanguage() {
            const lang = localStorage.getItem("dashboardLang") || "en";
            const t = i18n[lang];
            
            // Update Text
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (t[key]) el.innerText = t[key];
            });

            // Update Placeholders
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (t[key]) el.placeholder = t[key];
            });

            // Handle RTL
            if (lang === 'ur') {
                document.body.classList.add('rtl-mode');
                document.body.style.direction = 'rtl';
            } else {
                document.body.classList.remove('rtl-mode');
                document.body.style.direction = 'ltr';
            }
        }

        window.onload = async () => {
            applyFormLanguage();
            document.getElementById("display-date").innerText = new Date().toLocaleDateString();
            addNewRow(); 
            
            if (!user || !user.id || !user.sheetId) return alert("Session expired. Please login again.");

            try {
                const idRes = await fetch(`${API_URL}?action=getNextId&userId=${encodeURIComponent(user.id)}&sheetId=${user.sheetId}`);
                const idData = await idRes.json();
                document.getElementById("display-inv-id").innerText = idData.nextId;

                const setRes = await fetch(`${API_URL}?action=getSettings&userId=${user.id}&sheetId=${user.sheetId}`);
                const setData = await setRes.json();
                if(setData.status === "Success") {
                    taxPercent = parseFloat(setData.taxRate) || 0;
                    document.getElementById("tax-rate-display").innerText = taxPercent;
                    document.querySelectorAll(".curr-symbol").forEach(s => s.innerText = setData.currSymbol || "");
                }

                const clientRes = await fetch(`${API_URL}?action=getClients&userId=${user.id}&sheetId=${user.sheetId}`);
                clientsArray = await clientRes.json();
                const dataList = document.getElementById("client-list");
                clientsArray.forEach(c => {
                    const option = document.createElement("option");
                    option.value = c.name;
                    dataList.appendChild(option);
                });

            } catch (e) { 
                console.error("Initialization error:", e);
                document.getElementById("display-inv-id").innerText = "INV-1001"; 
            }
        };

        function autoFillClient(val) {
            const found = clientsArray.find(c => c.name === val);
            if (found) {
                document.getElementById("client-phone").value = found.phone || "";
            }
        }

        function addNewRow() {
            const tbody = document.getElementById("item-body");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" class="row-desc" placeholder="..."></td>
                <td><input type="number" class="row-qty" value="1" oninput="calculate()"></td>
                <td><input type="number" class="row-price" value="0" oninput="calculate()" onblur="checkAutoRow(this)"></td>
                <td class="row-amt" style="text-align:right">0.00</td>
                <td style="text-align:center" class="no-print"><button class="delete-btn" onclick="removeRow(this)">✖</button></td>
            `;
            tbody.appendChild(tr);
        }

        function checkAutoRow(input) {
            const rows = document.querySelectorAll("#item-body tr");
            if (input.parentElement.parentElement === rows[rows.length - 1] && input.value > 0) addNewRow();
        }

        function removeRow(btn) {
            if (document.querySelectorAll("#item-body tr").length > 1) {
                btn.parentElement.parentElement.remove();
                calculate();
            }
        }

        function calculate() {
            let subtotal = 0;
            document.querySelectorAll("#item-body tr").forEach(row => {
                const amt = (row.querySelector(".row-qty").value || 0) * (row.querySelector(".row-price").value || 0);
                row.querySelector(".row-amt").innerText = amt.toFixed(2);
                subtotal += amt;
            });
            const taxTotal = (subtotal * taxPercent) / 100;
            document.getElementById("sub-total").innerText = subtotal.toFixed(2);
            document.getElementById("tax-amount").innerText = taxTotal.toFixed(2);
            document.getElementById("grand-total").innerText = (subtotal + taxTotal).toFixed(2);
        }

        async function submitInvoice() {
            const client = document.getElementById("client-name").value;
            if (!client) return alert("Please enter Client Name");

            const btn = document.querySelector(".btn-gen");
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "...";

            const items = [];
            document.querySelectorAll("#item-body tr").forEach(row => {
                const desc = row.querySelector(".row-desc").value;
                if (desc) {
                    items.push({
                        description: desc,
                        qty: row.querySelector(".row-qty").value,
                        price: row.querySelector(".row-price").value,
                        amount: row.querySelector(".row-amt").innerText
                    });
                }
            });

            const payload = {
                action: "saveInvoice",
                sheetId: user.sheetId,
                invoiceId: document.getElementById("display-inv-id").innerText,
                userId: user.id,
                clientName: client,
                clientPhone: document.getElementById("client-phone").value,
                date: document.getElementById("display-date").innerText,
                subtotal: document.getElementById("sub-total").innerText,
                taxAmount: document.getElementById("tax-amount").innerText,
                total: document.getElementById("grand-total").innerText,
                items: items
            };

            try {
                await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                alert("✅ Invoice Saved!");
                window.print();
                window.location.reload(); 
            } catch (err) {
                alert("Error saving invoice.");
                btn.disabled = false; btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>
