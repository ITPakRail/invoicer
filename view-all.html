<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>View All Invoices</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');

        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #fff; color: #333; transition: all 0.3s; }
        body.rtl-mode { direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        body.rtl-mode th { text-align: right; }
        body.rtl-mode #searchBox { text-align: right; }

        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        #searchBox { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; outline: none; }
        
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-unpaid { background: #f8d7da; color: #721c24; }

        .btn { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 4px; font-size: 12px; transition: 0.3s; }
        .btn-print { background: #3498db; color: white; }
        .btn-wa { background: #25D366; color: white; }
        .btn-mail { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.8; }
        
        #loader { text-align: center; padding: 50px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header-area">
        <input type="text" id="searchBox" placeholder="ðŸ” Search..." data-placeholder="searchPlace" onkeyup="filterTable()">
        <button class="btn" style="background:#eee; color:#333;" onclick="loadData()" data-key="btnRefresh">ðŸ”„ Refresh</button>
    </div>

    <div id="loader" data-key="fetchMsg">Fetching your records...</div>

    <table id="invTable" class="hidden">
        <thead>
            <tr>
                <th data-key="thDate">Date</th>
                <th data-key="thInvId">Invoice ID</th>
                <th data-key="thClient">Client Name</th>
                <th data-key="thTotal">Grand Total</th>
                <th data-key="thStatus">Status</th>
                <th data-key="thActions">Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        // Use your actual Web App URL here
        const DATA_API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec"; 
        const user = JSON.parse(localStorage.getItem("user"));
        let cachedInvoices = [];

        const i18n = {
            en: {
                searchPlace: "ðŸ” Search by Client Name or ID...", btnRefresh: "ðŸ”„ Refresh",
                fetchMsg: "Fetching your records...", thDate: "Date", thInvId: "Invoice ID",
                thClient: "Client Name", thTotal: "Grand Total", thActions: "Actions",
                thStatus: "Status", thPaid: "Received", thBal: "Balance",
                btnPrint: "PDF", btnWA: "WhatsApp", btnMail: "Email", noPhone: "No Phone",
                thDesc: "Description", thQty: "Qty", thPrice: "Price"
            },
            ur: {
                searchPlace: "ðŸ” ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº...", btnRefresh: "ðŸ”„ Ø±ÛŒÙØ±ÛŒØ´",
                fetchMsg: "Ø±ÛŒÚ©Ø§Ø±Úˆ Ø­Ø§ØµÙ„ Ú©ÛŒØ§ Ø¬Ø§ Ø±ÛØ§ ÛÛ’...", thDate: "ØªØ§Ø±ÛŒØ®", thInvId: "Ø§Ù†ÙˆØ§Ø¦Ø³ Ø¢Ø¦ÛŒ ÚˆÛŒ",
                thClient: "Ú©Ù„Ø§Ø¦Ù†Ù¹ Ú©Ø§ Ù†Ø§Ù…", thTotal: "Ú©Ù„ Ø±Ù‚Ù…", thActions: "Ø§ÛŒÚ©Ø´Ù†Ø²",
                thStatus: "Ø­Ø§Ù„Øª", thPaid: "ÙˆØµÙˆÙ„ Ø´Ø¯Û", thBal: "Ø¨Ù‚Ø§ÛŒØ§",
                btnPrint: "Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ", btnWA: "ÙˆØ§Ù¹Ø³ Ø§ÛŒÙ¾", btnMail: "Ø§ÛŒ Ù…ÛŒÙ„", noPhone: "ÙÙˆÙ† Ù†Ù…Ø¨Ø± Ù†ÛÛŒÚº ÛÛ’",
                thDesc: "ØªÙØµÛŒÙ„", thQty: "ØªØ¹Ø¯Ø§Ø¯", thPrice: "Ù‚ÛŒÙ…Øª"
            }
        };

        window.onload = () => { applyLanguage(); loadData(); };

        function applyLanguage() {
            const lang = localStorage.getItem("dashboardLang") || "en";
            const t = i18n[lang];
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (t[key]) el.innerText = t[key];
            });
            const search = document.getElementById("searchBox");
            if (search && t.searchPlace) search.placeholder = t.searchPlace;
            document.body.classList.toggle('rtl-mode', lang === 'ur');
        }

        async function loadData() {
            if (!user || !user.sheetId) return;
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            document.getElementById("loader").classList.remove("hidden");
            document.getElementById("invTable").classList.add("hidden");

            try {
                const response = await fetch(`${DATA_API_URL}?action=getInvoices&userId=${user.id}&sheetId=${user.sheetId}`);
                const data = await response.json();
                
                // Mapped to your specific GAS column indices
                cachedInvoices = data; 

                document.getElementById("loader").classList.add("hidden");
                document.getElementById("invTable").classList.remove("hidden");

                const lang = localStorage.getItem("dashboardLang") || "en";
                cachedInvoices.forEach(inv => {
                    // Check status and handle case sensitivity
                    const statusText = inv.Status || "Unpaid";
                    const statusClass = `status-${statusText.toLowerCase()}`;
                    
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${inv.Date}</td>
                        <td><strong>${inv.Invoice_ID}</strong></td>
                        <td>${inv.Client_Name}<br><small>${inv.Client_Phone || i18n[lang].noPhone}</small></td>
                        <td>
                            <strong>${parseFloat(inv.Total_Amount || 0).toFixed(2)}</strong><br>
                            <small style="color:#e74c3c">${i18n[lang].thBal}: ${parseFloat(inv.Balance_Amount || 0).toFixed(2)}</small>
                        </td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-print" onclick="generatePDF('${inv.Invoice_ID}')">${i18n[lang].btnPrint}</button>
                            <button class="btn btn-wa" onclick="handleShare('${inv.Invoice_ID}', 'wa')">${i18n[lang].btnWA}</button>
                            <button class="btn btn-mail" onclick="handleShare('${inv.Invoice_ID}', 'mail')">${i18n[lang].btnMail}</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) { document.getElementById("loader").innerText = "âš ï¸ Error loading data."; }
        }

        function generatePDF(id) {
            const inv = cachedInvoices.find(i => String(i.Invoice_ID) === String(id));
            if (!inv) return;
            const lang = localStorage.getItem("dashboardLang") || "en";
            const t = i18n[lang];
            
            let items = [];
            try {
                items = (typeof inv.Items_JSON === 'string') ? JSON.parse(inv.Items_JSON) : inv.Items_JSON;
            } catch(e) { console.error("JSON Error", e); }

            let rows = "";
            if(Array.isArray(items)) {
                items.forEach(i => { 
                    // Handles both lowercase and uppercase keys from JSON
                    const d = i.description || i.Description || "-";
                    const q = i.qty || i.Qty || 0;
                    const p = i.price || i.Price || 0;
                    const a = i.amount || i.Amount || (q * p);
                    rows += `<tr><td>${d}</td><td>${q}</td><td>${p}</td><td align="right">${parseFloat(a).toFixed(2)}</td></tr>`; 
                });
            }

            const dir = lang === 'ur' ? 'rtl' : 'ltr';
            const align = lang === 'ur' ? 'right' : 'left';
            let logoImg = user.logo ? `<img src="${user.logo}" style="max-height:70px; margin-bottom:10px;">` : "";

            const printWin = window.open('', '_blank');
            printWin.document.write(`<html><head><style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap');
                body{font-family: 'Segoe UI', 'Noto Nastaliq Urdu', serif; padding:40px; direction:${dir}} 
                table{width:100%; border-collapse:collapse; margin-top:20px} 
                th,td{border:1px solid #ddd; padding:10px; text-align:${align}} 
                th{background:#f4f4f4}
                .summary-box { margin-top:20px; text-align:${lang === 'ur' ? 'left' : 'right'} }
            </style></head><body>
                ${logoImg}
                <h2 style="margin-top:0;">${user.business}</h2>
                <p>${t.thInvId}: ${inv.Invoice_ID} | ${t.thDate}: ${inv.Date}</p>
                <p><strong>${t.thClient}:</strong> ${inv.Client_Name}</p>
                <table><thead><tr><th>${t.thDesc}</th><th>${t.thQty}</th><th>${t.thPrice}</th><th>${t.thTotal}</th></tr></thead>
                <tbody>${rows}</tbody></table>
                <div class="summary-box">
                    <p>${t.thTotal}: ${parseFloat(inv.Total_Amount).toFixed(2)}</p>
                    <p>${t.thPaid}: ${parseFloat(inv.Paid_Amount).toFixed(2)}</p>
                    <h3>${t.thBal}: ${parseFloat(inv.Balance_Amount).toFixed(2)}</h3>
                </div>
                <script>window.onload=function(){window.print();window.close();}<\/script>
            </body></html>`);
            printWin.document.close();
        }

        async function handleShare(id, platform) {
            const inv = cachedInvoices.find(i => String(i.Invoice_ID) === String(id));
            if (!inv) return;
            const lang = localStorage.getItem("dashboardLang") || "en";
            const t = i18n[lang];
            const msg = `${t.thInvId}: ${inv.Invoice_ID}\n${t.thTotal}: ${inv.Total_Amount}\n${t.thBal}: ${inv.Balance_Amount}`;
            
            if (platform === 'wa') {
                const cleanPhone = String(inv.Client_Phone).replace(/\D/g, '');
                window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(msg)}`, '_blank');
            } else {
                window.location.href = `mailto:?subject=Invoice ${inv.Invoice_ID}&body=${encodeURIComponent(msg)}`;
            }
        }

        function filterTable() {
            const input = document.getElementById("searchBox").value.toUpperCase();
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
            });
        }
    </script>
</body>
</html>
