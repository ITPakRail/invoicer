<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>View All Invoices</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #fff; color: #333; }
        body.rtl-mode { direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        #searchBox { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .btn { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 4px; font-size: 12px; }
        .btn-print { background: #3498db; color: white; }
        .btn-wa { background: #25D366; color: white; }
        .btn-mail { background: #e74c3c; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header-area">
        <input type="text" id="searchBox" placeholder="ðŸ” Search..." onkeyup="filterTable()">
        <button class="btn" style="background:#eee;" onclick="loadData()">ðŸ”„ Refresh</button>
    </div>

    <div id="loader">Fetching records...</div>

    <table id="invTable" class="hidden">
        <thead>
            <tr>
                <th>Date</th>
                <th>Invoice ID</th>
                <th>Client Name</th>
                <th>Grand Total</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        const DATA_API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec"; 
        const user = JSON.parse(localStorage.getItem("user"));
        let cachedInvoices = [];

        window.onload = () => { loadData(); };

        async function loadData() {
            if (!user || !user.sheetId) return;
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            try {
                const response = await fetch(`${DATA_API_URL}?action=getInvoices&userId=${user.id}&sheetId=${user.sheetId}`);
                const data = await response.json();
                
                // FIXED MAPPING: Matches your GS output exactly
                cachedInvoices = data.map(row => ({
                    invoiceId: row.Invoice_ID, 
                    clientName: row.Client_Name,
                    clientPhone: row.Client_Phone || "", 
                    date: row.Date,
                    total: row.Total_Amount || 0, 
                    items: row.Items_JSON || "[]",
                    paidAmount: row.Paid_Amount || 0, 
                    balanceAmount: row.Balance_Amount || 0,
                    status: row.Status || "Paid"
                }));

                document.getElementById("loader").classList.add("hidden");
                document.getElementById("invTable").classList.remove("hidden");

                cachedInvoices.forEach(inv => {
                    const statusClass = `status-${inv.status.toLowerCase()}`;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${inv.date}</td>
                        <td><strong>${inv.invoiceId}</strong></td>
                        <td>${inv.clientName}</td>
                        <td>
                            <strong>${parseFloat(inv.total).toFixed(2)}</strong><br>
                            <small style="color:#e74c3c">Balance: ${parseFloat(inv.balanceAmount).toFixed(2)}</small>
                        </td>
                        <td><span class="badge ${statusClass}">${inv.status}</span></td>
                        <td>
                            <button class="btn btn-print" onclick="generatePDF('${inv.invoiceId}')">PDF</button>
                            <button class="btn btn-wa" onclick="handleShare('${inv.invoiceId}', 'wa')">WhatsApp</button>
                            <button class="btn btn-mail" onclick="handleShare('${inv.invoiceId}', 'mail')">Email</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) { document.getElementById("loader").innerText = "âš ï¸ Error."; }
        }

        function generatePDF(id) {
            const inv = cachedInvoices.find(i => i.invoiceId === id);
            if (!inv) return;
            let items = JSON.parse(inv.items);
            let rows = "";
            items.forEach(i => { 
                rows += `<tr><td>${i.description}</td><td>${i.qty}</td><td>${i.price}</td><td align="right">${i.amount}</td></tr>`; 
            });
            const printWin = window.open('', '_blank');
            printWin.document.write(`<html><body>
                <h2>${user.business}</h2>
                <p>Invoice: ${inv.invoiceId} | Date: ${inv.date}</p>
                <p>Client: ${inv.clientName}</p>
                <table border="1" style="width:100%; border-collapse:collapse;">
                    <thead><tr><th>Desc</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <p>Total: ${inv.total}</p>
                <p>Paid: ${inv.paidAmount}</p>
                <p><b>Balance: ${inv.balanceAmount}</b></p>
                <script>window.onload=function(){window.print();window.close();}<\/script>
            </body></html>`);
            printWin.document.close();
        }

        async function handleShare(id, platform) {
            const inv = cachedInvoices.find(i => i.invoiceId === id);
            if (!inv) return;
            const msg = `Invoice: ${inv.invoiceId}\nTotal: ${inv.total}\nPaid: ${inv.paidAmount}\nBalance: ${inv.balanceAmount}`;
            if (platform === 'wa') {
                window.open(`https://api.whatsapp.com/send?phone=${inv.clientPhone}&text=${encodeURIComponent(msg)}`, '_blank');
            } else {
                window.location.href = `mailto:?subject=Invoice ${inv.invoiceId}&body=${encodeURIComponent(msg)}`;
            }
        }

        function filterTable() {
            const input = document.getElementById("searchBox").value.toUpperCase();
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
            });
        }
    </script>
</body>
</html>
