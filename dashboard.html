<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eInvoicer - MultiVendor Dashboard</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --text-light: #ecf0f1; --danger: #e74c3c; --success: #27ae60; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; height: 100vh; }
        .hidden { display: none !important; }

        /* AUTH & MODAL STYLES */
        #auth-container, .modal-overlay { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .auth-card, .modal-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-secondary { width: 100%; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }

        /* DASHBOARD STYLES */
        #main-dashboard { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: 60px 1fr 40px; height: 100vh; }
        header { grid-column: 1 / -1; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        
        aside { background: var(--secondary); color: white; padding: 20px 0; display: flex; flex-direction: column; }
        .logo-container { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); overflow: hidden; margin: 0 auto 20px auto; background: white; display: flex; justify-content: center; align-items: center; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }

        aside ul { list-style: none; padding: 0; width: 100%; margin: 0; }
        aside li { padding: 15px 25px; cursor: pointer; transition: 0.3s; border-bottom: 1px solid #ffffff10; }
        aside li:hover { background: var(--accent); }

        /* SUBMENU */
        .submenu { background: #2c3e50; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .submenu li { padding-left: 45px; font-size: 14px; background: #243342; }
        .submenu.open { max-height: 200px; }

        .sidebar-footer { margin-top: auto; padding: 10px; }
        .btn-link { color: #bdc3c7; background: none; border: none; cursor: pointer; font-size: 13px; text-decoration: underline; }

        main { padding: 30px; overflow-y: auto; }
        footer { grid-column: 1 / -1; background: #ddd; text-align: center; line-height: 40px; font-size: 12px; color: #666; }
        .user-badge { font-size: 13px; background: #1abc9c; padding: 5px 10px; border-radius: 20px; }

        /* NEW SCORECARD STYLES */
        .biz-panel { background: var(--primary); color: white; padding: 40px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
        .biz-panel h1 { margin: 0; font-size: 2.5em; text-transform: uppercase; letter-spacing: 2px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--accent); }
        .stat-card h4 { margin: 0; color: #7f8c8d; font-size: 0.85em; text-transform: uppercase; }
        .stat-card .value { font-size: 1.8em; font-weight: bold; color: var(--primary); margin-top: 10px; display: block; }
        .card-inv { border-top-color: var(--accent); }
        .card-cli { border-top-color: #9b59b6; }
        .card-amt { border-top-color: var(--success); }
        .card-tax { border-top-color: var(--warning); }
    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-card">
        <h1>eInvoicer</h1>
        <input type="email" id="l_email" placeholder="Email">
        <input type="password" id="l_pass" placeholder="Password">
        <button class="btn-primary" onclick="doLogin()">Login</button>
        <p id="msg" style="color: red; font-size: 14px;"></p>
    </div>
</div>

<div id="pwd-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <h3>Change Password</h3>
        <input type="password" id="oldPass" placeholder="Old Password">
        <input type="password" id="newPass" placeholder="New Password">
        <button id="savePassBtn" class="btn-primary" onclick="savePassword()">Update</button>
        <button class="btn-secondary" onclick="closePwdModal()">Cancel</button>
        <p id="pwd-msg" style="font-size: 12px; margin-top: 10px;"></p>
    </div>
</div>

<div id="main-dashboard" class="hidden">
    <header>
        <div style="font-size: 20px; font-weight: bold;">eInvoicer</div>
        <div class="user-info">
            <span class="user-badge" id="display-userid">ID: --</span>
            <span id="display-username" style="margin-left: 10px;">Welcome, User</span>
            <button onclick="logout()" style="width: auto; padding: 5px 10px; background: var(--danger); color:white; border:none; margin-left: 15px; border-radius: 5px; cursor:pointer;">Logout</button>
        </div>
    </header>

    <aside>
        <div id="logo-wrapper" class="logo-container hidden">
            <img id="user-logo" src="" alt="Business Logo">
      </div>

    <ul>
    <li onclick="goToDashboard()">üè† Dashboard</li>
     <li onclick="showSection('create')">‚ûï Create Invoice</li>
     <li onclick="showSection('view-all')">üìÑ View All Invoices</li>
     <li onclick="showSection('update')">‚úèÔ∏è Edit or Delete</li>
     <li onclick="showSection('report')">üìä Reports</li>
     
     <li onclick="toggleMenu('clients-menu')">üë• Clients ‚ñæ</li>
     <ul id="clients-menu" class="submenu">
         <li onclick="showSection('add-client')">üë§ Add Client</li>
         <li onclick="showSection('view-clients')">üìã Client List</li>
     </ul>

     <li onclick="toggleMenu('settings-menu')">‚öôÔ∏è Settings ‚ñæ</li>
     <ul id="settings-menu" class="submenu">
         <li onclick="showSection('biz-settings')">üè¢ Business Setting</li>
         <li onclick="showSection('tax-settings')">üí∞ Tax Setting</li>
         <li onclick="showSection('currency-settings')">üí± Set Currency</li>
     </ul>
</ul>

        <div class="sidebar-footer">
            <button class="btn-link" onclick="openPwdModal()">Change Password</button>
        </div>
    </aside>

    <main id="content-area">
        <div id="welcome-msg">
            <div class="biz-panel">
                <h1 id="display-bizname">BUSINESS NAME</h1>
                <p>Business Management Overview</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card card-inv">
                    <h4>Total Invoices</h4>
                    <span class="value" id="stat-inv">0</span>
                </div>
                <div class="stat-card card-cli">
                    <h4>Total Clients</h4>
                    <span class="value" id="stat-cli">0</span>
                </div>
                <div class="stat-card card-amt">
                    <h4>Total Amount</h4>
                    <span class="value" id="stat-amt">0.00</span>
                </div>
                <div class="stat-card card-tax">
                    <h4>Total Tax</h4>
                    <span class="value" id="stat-tax">0.00</span>
                </div>
            </div>
        </div>
        
        <div id="module-container" class="hidden">
            <iframe id="content-frame" src="" style="width: 100%; height: 85vh; border: none; border-radius: 8px; background: white;"></iframe>
        </div>
    </main>

    <footer>Copyrights ¬© <span id="year"></span> eInvoicer | All Rights Reserved</footer>
</div>

<script>
    // 1. URL points to your Multi-Tenant GAS Deployment
    const API_URL = "https://script.google.com/macros/s/AKfycbwpyyuTtbSv_2udttbXog8oUfq_vgFvr-y7DggVO-WXYkR4APnpB_0BS6TpSZLdnBrN/exec";
    const user = JSON.parse(localStorage.getItem("user"));

    window.onload = () => {
        if (!user || !user.sheetId) {
            alert("Please login first");
            return;
        }
        document.getElementById('biz-name').innerText = user.business + " Sales Report";
        
        // Default dates: 1st of month to today (Keep your original logic)
        const d = new Date();
        document.getElementById('start-date').value = new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('end-date').value = d.toISOString().split('T')[0];
    };

    async function generateReport() {
        const btn = document.querySelector('.btn-view');
        const startInput = document.getElementById('start-date').value; 
        const endInput = document.getElementById('end-date').value;     

        if (!startInput || !endInput) return alert("Select dates");

        btn.innerText = "Searching...";
        btn.disabled = true;

        try {
            // MULTI-TENANT CHANGE: Pass sheetId instead of userId to access private sheet
            const response = await fetch(`${API_URL}?action=getInvoices&sheetId=${user.sheetId}`);
            const allData = await response.json();
            
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = "";
            
            let count = 0;
            let revenue = 0;

            // KEEP OLD VERSION DATE LOGIC
            const rangeStart = new Date(startInput + "T00:00:00").getTime();
            const rangeEnd = new Date(endInput + "T23:59:59").getTime();

            allData.forEach(inv => {
                // Convert sheet date (M/D/YYYY) to a JS Date object
                const parts = inv.date.split("/");
                let invDate;
                
                if (parts.length === 3) {
                    // Assumes sheet is M/D/YYYY (Old Model Format)
                    invDate = new Date(parts[2], parts[0] - 1, parts[1]).getTime();
                } else {
                    // Fallback for ISO strings
                    invDate = new Date(inv.date).getTime();
                }

                // Comparison Logic
                if (invDate >= rangeStart && invDate <= rangeEnd) {
                    count++;
                    revenue += parseFloat(inv.total || 0);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${inv.date}</td>
                        <td><strong>${inv.invoiceId}</strong></td>
                        <td>${inv.clientName}</td>
                        <td style="text-align:right">${parseFloat(inv.total).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.getElementById('total-count').innerText = count;
            document.getElementById('total-revenue').innerText = revenue.toFixed(2);

            if (count === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">No invoices found in this range.</td></tr>`;
            }

        } catch (err) {
            console.error("Report Error:", err);
            alert("Error loading data from your private sheet.");
        } finally {
            btn.innerText = "Generate Report";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
